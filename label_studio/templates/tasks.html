{% extends 'base.html' %}
{% block body %}

  <div class="ui container">
    <center class="wrapper">

      <!-- Statistics -->
      <div class="ui two column centered grid">
        <div class="row">
        <div class="column center aligned">
          <div class="ui statistic">
            <span class="value">{{ task_ids|length }}</span>
            <span class="label">Total tasks</span>
            {% if show_paths %}
              <i class="small">{{ project.source_storage.readable_path }}</i>
            {% endif %}
          </div>
        </div>
        <div class="column center aligned">
          <div class="ui statistic">
            <span class="value">{{ completions|length }}</span>
            <span class="label">Total completions</span>
            {% if show_paths %}
              <i class="small">{{ project.target_storage.readable_path }}</i>
            {% endif %}
          </div>
        </div>
        </div>

        <div class="row">
          <div class="ui message">
            <p>Tasks sampling: <span class="ui orange horizontal label">{{ config['sampling'] }}</span> </p>
          </div>
        </div>

        <div class="row">
          {% if task_ids|length > 0 %}
            <a class="ui button positive" href=".">Start Labeling</a>
            {% if project.can_manage_tasks %}
              <a id="clear-tasks-button" class="ui button red">Delete All Tasks</a>
            {% endif %}
          {% else %}
            {% if project.can_manage_tasks %}
              <a class="ui button positive" href="import">Import Tasks</a>
            {% endif %}
          {% endif %}
        </div>

      </div>
      {% if task_ids|length > 0 %}
      <div class="ui divider hidden"></div>
      <!-- Table -->
      <table>
        <tr>
          <th>Task ID </th>
          <th>Completed at</th>
          {% if project.can_manage_completions %}
            <th>Delete completion?</th>
          {% endif %}
          {% if project.can_manage_tasks %}
            <th>Delete task?</th>
          {% endif %}
        </tr>

        {% for id in task_ids %}
          <tr>
            <td class="text-center">
              <a href=".?task_id={{ id }}">
                <i class="fas fa-eye eye show-completion"></i>
              </a>
              &nbsp;
              {{ id }}
            </td>
            <td>{{ completed_at[id] }}</td>
          {% if project.can_manage_completions %}
            <td class="text-center">
              {% if id in completions %}
                <i data-task-id="{{ id }}" class="fas fa-trash-alt trash remove-completion"></i>
              {% endif %}
            </td>
          {% endif %}
          {% if project.can_manage_tasks %}
            <td class="text-center">
              <i data-task-id="{{ id }}" class="fas fa-trash-alt trash remove-task"></i>
            </td>
          {% endif %}
          </tr>
        {% endfor %}
      </table>
      {% endif %}
      <br/>
    </center></div>
  <br/><br/>


  <script>
    document.querySelectorAll(".remove-completion").forEach(function (test) {
      test.addEventListener("click", function (event) {
        var id = event.target.dataset.taskId;
        var request = new XMLHttpRequest();
        request.open("DELETE", "api/tasks/" + id + "/completions/" + id + "/", true);
        request.onload = function () {
          window.location.reload();
        };
        request.send(null);
      })
    });

    document.querySelectorAll(".remove-task").forEach(function (test) {
      test.addEventListener("click", function (e){
        const confirmed = confirm('Are you sure to delete the task?');
        if (confirmed) {
          var id = e.target.dataset.taskId;
          let request = new XMLHttpRequest();
          request.open("DELETE", "api/tasks/" + id + "/");
          request.onload = function () {
            location.reload();
          };
          request.send(null);
        }})
    });

    document.getElementById("clear-tasks-button").onclick = function (e) {
      const deletion_confirmed = confirm(
        'You are going to delete all existing tasks.\nWarning! this operation cannot be undone.\nPlease confirm your action.');
      if (deletion_confirmed) {
        let request = new XMLHttpRequest();
        request.open("DELETE", "api/tasks/delete", true);
        request.onload = function () {
          window.location.reload();
        };
        request.send(null);
      }
    }
  </script>

{% endblock %}
