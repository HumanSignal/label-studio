---
test_name: test_users
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref

- id: get_my_user
  type: ref

- name: stage
  request:
    method: GET
    url: '{django_live_url}/api/users'
  response:
    status_code: 200

- name: stage
  request:
    method: GET
    url: '{django_live_url}/api/users/{user_pk}'
  response:
    status_code: 200
    save:
      json:
        org_pk: active_organization

- name: stage
  request:
    json:
      email: test_user@heartextest.com
      username: test user
      active_organization: !int '{org_pk}'
    method: POST
    url: '{django_live_url}/api/users'
  response:
    save:
      json:
        new_user_pk: id
    status_code: 201

- name: stage
  request:
    method: GET
    url: '{django_live_url}/api/users/{new_user_pk}'
  response:
    status_code: 200

- name: attempt_update_email_raises_405
  request:
    url: "{django_live_url}/api/users/{new_user_pk}"
    json:
      email: test_user_new_email_change@heartextest.com
    method: PATCH
    headers:
      content-type: application/json
  response:
    status_code: 405

---
test_name: test_users_malicious_redirect
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
  - name: malicious_signup
    request:
      url: "{django_live_url}/user/signup?next=http://malicious.com"
      data:
        email: test_second_org@heartex.com
        password: 12345678
      method: POST
    response:
      status_code: 302
      headers:
        location: "/projects/" # redirect to projects page rather than malicious.com

  - name: malicious_login
    request:
      url: "{django_live_url}/user/login?next=http://malicious.com"
      data:
        email: test_second_org@heartex.com
        password: 12345678
      method: POST
    response:
      status_code: 302
      headers:
        location: "/projects/" # redirect to projects page rather than malicious.com

---
test_name: test_users_soft_delete
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref

- id: get_my_user
  type: ref

- name: get_active_organization
  request:
    method: GET
    url: '{django_live_url}/api/users/{user_pk}'
  response:
    status_code: 200
    save:
      json:
        org_pk: active_organization

- type: ref
  id: get_invite_url

- type: ref
  id: logout

# signup 2 new users
- name: signup_new_user_under_active_organization
  request:
    url: "{django_live_url}{invite_url}"
    data:
      email: test_user@heartextest.com
      password: 12345678
    method: POST
  response:
    status_code: 302

- type: ref
  id: logout

- name: signup_second_new_user_under_active_organization
  request:
    url: "{django_live_url}{invite_url}"
    data:
      email: test_second_user@heartextest.com
      password: 12345678
    method: POST
  response:
    status_code: 302

- id: get_my_user # get user_pk to use in soft-delete
  type: ref

- id: get_user_token
  type: ref

- id: logout
  type: ref

- id: get_my_user_with_token
  name: Get my user with token
  request:
    headers:
      authorization: "Token {user_token}"
    url: "{django_live_url}/api/current-user/whoami"
    method: GET
  response:
    status_code: 200

- name: login_as_first_new_user
  request:
    url: "{django_live_url}/user/login"
    data:
      email: test_user@heartextest.com
      password: 12345678
    method: POST
  response:
    status_code: 302

- name: soft_delete_user_fails_without_owner_logged_in
  request:
    url: "{django_live_url}/api/users/{user_pk}/soft-delete"
    method: DELETE
  response:
    status_code: 403

- id: logout
  type: ref

- id: login # as owner
  type: ref

- name: soft_delete_user_succeeds_as_owner
  request:
    url: "{django_live_url}/api/users/{user_pk}/soft-delete"
    method: DELETE
  response:
    status_code: 204

- name: soft_delete_user_fails_second_deletion_attempt
  request:
    url: "{django_live_url}/api/users/{user_pk}/soft-delete"
    method: DELETE
  response:
    status_code: 404

- id: logout
  type: ref

- name: get_my_user_with_token_fails_as_user_is_now_deleted
  request:
    headers:
      authorization: "Token {user_token}"
    url: "{django_live_url}/api/current-user/whoami"
    method: GET
  response:
    status_code: 401
---
test_name: test_users_write_permission
strict: False
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref

- type: ref
  id: get_my_user

- name: get_owner_user_id
  request:
    url: "{django_live_url}/api/current-user/whoami"
    method: GET
  response:
    status_code: 200
    save:
      json:
        owner_pk: id

- name: stage
  request:
    method: GET
    url: '{django_live_url}/api/users'
  response:
    status_code: 200

- name: get_active_organization
  request:
    method: GET
    url: '{django_live_url}/api/users/{owner_pk}'
  response:
    status_code: 200
    save:
      json:
        org_pk: active_organization

- id: get_invite_url
  type: ref

- id: logout
  type: ref

- name: signup_annotator_under_active_organization
  request:
    url: "{django_live_url}/user/signup?token={invite_token}"
    data:
      email: test_fourth_user_anno@heartextest.com
      username: test fourthuseranno
      active_organization: !int '{org_pk}'
      password: 12345678
    method: POST
  response:
    status_code: 302

- name: login_as_new_user_anno
  request:
    url: "{django_live_url}/user/login"
    data:
      email: test_fourth_user_anno@heartextest.com
      password: 12345678
    method: POST
  response:
    status_code: 302

- name: get_anno_user_id
  request:
    url: "{django_live_url}/api/current-user/whoami"
    method: GET
  response:
    status_code: 200
    save:
      json:
        anno_pk: id

- name: change_own_user_email_as_non_admin
  request:
    url: "{django_live_url}/api/users/{anno_pk}"
    data:
      email: some_other_email@heartextest.com
    method: PATCH
  response:
    status_code: 405

- id: logout
  type: ref

- name: login_as_owner
  request:
    url: "{django_live_url}/user/login"
    data:
      email: test_suites_user@heartex.com
      password: 12345678
    method: POST
  response:
    status_code: 302

- name: get_owner_user_id
  request:
    url: "{django_live_url}/api/current-user/whoami"
    method: GET
  response:
    status_code: 200
    save:
      json:
        owner_pk: id

- name: change_my_email_as_owner
  request:
    url: "{django_live_url}/api/users/{owner_pk}"
    data:
      email: some_other_email@heartextest.com
    method: PATCH
  response:
    status_code: 405

- name: check_my_email_did_not_change
  request:
    url: "{django_live_url}/api/users/{owner_pk}"
    method: GET
  response:
    status_code: 200
    json:
      email: test_suites_user@heartex.com

- name: change_anno_email_as_owner
  request:
    url: "{django_live_url}/api/users/{anno_pk}"
    data:
      email: some_other_email@heartextest.com
    method: PATCH
  response:
    status_code: 405

- name: check_anno_email_did_not_change
  request:
    url: "{django_live_url}/api/users/{anno_pk}"
    method: GET
  response:
    status_code: 200
    json:
      email: test_fourth_user_anno@heartextest.com
