---
test_name: Reset project summary created_labels, created_annotation and created_labels_drafts
strict: false
marks:
- usefixtures:
  - django_live_url

stages:

- id: signup
  type: ref

- name: stage
  request:
    method: POST
    url: '{django_live_url}/api/projects'
  response:
    save:
      json:
        pk: id
    status_code: 201

- name: Set labeling config
  request:
    headers:
      content-type: application/json
    json:
      label_config: '<View><Header value="Select label and click the image to start"/><Image name="image" value="$image" zoom="true"/><PolygonLabels name="label" toName="image" strokeWidth="3" pointSize="small" opacity="0.9" value="$options"/></View>'
    method: PATCH
    url: '{django_live_url}/api/projects/{pk}'
  response:
    status_code: 200

- name: Import a task with image
  request:
    headers:
      content-type: application/json
    json:
      data:
        image: "https://develop.dev.heartex.com/static/samples/sample.jpg"
        options:
          - value: "a"
          - value: "b"
    method: POST
    url: '{django_live_url}/api/projects/{pk}/import'
  response:
    status_code: 201

- name: Get next task
  request:
    method: GET
    url: '{django_live_url}/api/projects/{pk}/next'
  response:
    save:
      json:
        task_id: id
    status_code: 200

- name: Submit a draft for the task
  request:
    headers:
      content-type: application/json
    json:
      result: [
        {
          "id": "draft1",
          "from_name": "label",
          "to_name": "image",
          "type": "polygonlabels",
          "value": {
            "points": [
              [0.1, 0.1],
              [0.1, 0.9],
              [0.9, 0.9]
            ],
            "polygonlabels": ["a"]
          }
        }
      ]
    method: POST
    url: '{django_live_url}/api/tasks/{task_id}/drafts'
  response:
    save:
      json:
        draft_id: id
    status_code: 201

- name: Submit an annotation
  request:
    headers:
      content-type: application/json
    json:
      result: [
        {
          "id": "annotation1",
          "from_name": "label",
          "to_name": "image",
          "type": "polygonlabels",
          "value": {
            "points": [
              [0.1, 0.1],
              [0.1, 0.9],
              [0.9, 0.9]
            ],
            "polygonlabels": ["a"]
          }
        }
      ]
    method: POST
    url: '{django_live_url}/api/tasks/{task_id}/annotations/'
  response:
    status_code: 201
    save:
      json:
        annotation_id: id

- name: Try (1) to validate labeling config and remove existing labels
  request:
    headers:
      content-type: application/json
    json:
      label_config: ' <View><Text name="text" value="$text"/><Choices name="sentiment" toName="text" choice="single" showInLine="true"> <Choice value="2"/>
    </Choices></View>'
    method: POST
    url: '{django_live_url}/api/projects/{pk}/validate'
  response:
    status_code: 400

- name: Reset and recalc summary created_labels, created_annotation, created_labels_drafts
  request:
    method: POST
    url: '{django_live_url}/api/projects/{pk}/summary/reset'
  response:
    status_code: 200

- name: Get project summary
  request:
    method: GET
    url: '{django_live_url}/api/projects/{pk}/summary'
  response:
    json: {
      "all_data_columns": {"image": 2, "options": 2},
      "common_data_columns": ["image", "options"],
      "created_annotations": {"label|image|polygonlabels": 1},
      "created_labels": {"label": {"a": 1}},
      "created_labels_drafts": {"label": {"a": 1}}
    }
    status_code: 200

- name: Delete draft
  request:
    method: DELETE
    url: '{django_live_url}/api/drafts/{draft_id}'
  response:
    status_code: 204

- name: Delete annotation
  request:
    method: DELETE
    url: '{django_live_url}/api/annotations/{annotation_id}'
  response:
    status_code: 204

- name: Try (2) to validate labeling config and remove existing labels, it should be OK!
  request:
    headers:
      content-type: application/json
    json:
      label_config: ' <View><Text name="text" value="$text"/><Choices name="sentiment" toName="text" choice="single" showInLine="true"> <Choice value="2"/>
    </Choices></View>'
    method: POST
    url: '{django_live_url}/api/projects/{pk}/validate'
  response:
    status_code: 200